@{
    ViewBag.Title = "Add Equipment";
}

<h1>Dodaj urządzenie</h1>

<form action="~/add-equipment" method="post" enctype='multipart/form-data'>
<div class="w-50 float-left">   
        <div class="form-field flex">
            <div class="w-25">
                <label class="form-label">Oddział</label>
            </div>
            <div class="flex-1">
                <input type="radio" class="ml" id="Czarna Białostocka" name="Location1" value="Czarna Białostocka" checked="checked" />
                <label for="Czarna Białostocka">Czarna Białostocka</label>
                <input type="radio" class="ml" id="Wyszków" name="Location1" value="Wyszków" />
                <label for="Wyszków">Wyszków</label>
            </div>
        </div>

        <div class="form-field flex">
            <div class="w-25">
                <label class="form-label pt" for="TypeId">Rodzaj</label>
            </div>
            <div class="flex-1">
                <select name="TypeId" id="TypeId" class="form-input">
                    <option value="">Wybierz rodzaj</option>
                    @foreach (var type in ViewBag.Types)
                    {
                        <option value="@type.TypeId">@type.TypeName</option>
                    }
                </select>
            </div>
        </div>

        <div class="form-field flex">
            <div class="w-25">
                <label class="form-label pt" for="Location2Id">Lokalizacja</label>
            </div>
            <div class="flex-1">
                <select name="Location2Id" id="Location2Id" class="form-input">
                    <option value="">Wybierz lokalizację</option>
                    @foreach (var location in ViewBag.Locations)
                    {
                        <option value="@location.Location2Id">@location.Location2Name</option>
                    }
                </select>
            </div>
        </div>

        <div class="form-field flex">
            <div class="w-25">
                <label class="form-label pt" for="Location3">Miejsce</label>
            </div>
            <div class="flex-1">
                <input class="form-input" type="text" id="Location3" name="Location3" />
            </div>
        </div>        

        <div class="form-field flex">
            <div class="w-25">
                <label class="form-label pt" for="Notes">Uwagi</label>
            </div>
            <div class="flex-1">
                <textarea class="form-input" id="Notes" name="Notes"></textarea>
            </div>
        </div>        

        <div class="form-field flex">
            <div class="w-25">                
            </div>
            <div class="flex-1">
                <button class="button button-green-back">Dodaj</button>
            </div>
        </div>   
</div>

<div class="w-50 float-left" id="additionalFieldsContainer"></div>

</form>

@section scripts {
    <script>
        
        document.getElementById("TypeId").addEventListener("change", function () {
            var selectedTypeId = this.value;
            
            if (selectedTypeId) {
                fetch("/add-equipment/AdditionalFields?selectedTypeId=" + selectedTypeId)
                    .then(response => response.text())
                    .then(data => {                        
                        document.getElementById("additionalFieldsContainer").innerHTML = data;
                    });
            } else {                
                document.getElementById("additionalFieldsContainer").innerHTML = "";
            }
        });

        window.addEventListener("load", () => {
            const input = document.getElementById("upload");
            const filewrapper = document.getElementById("filewrapper");
            const submitButton = document.getElementById("submitBtn1");

            let selectedFiles = [];

            input.addEventListener("change", (e) => {
                const files = e.target.files;
                for (let i = 0; i < files.length; i++) {
                    let file = files[i];
                    let fileName = file.name;
                    let fileType = fileName.split(".").pop();
                    let fileURL = URL.createObjectURL(file); // Tworzy tymczasowy adres URL dla pliku

                    fileshow(fileName, fileType, fileURL, file);
                }
            });

            const fileshow = (fileName, fileType, fileURL, file) => {
                const showfileboxElem = document.createElement("div");
                showfileboxElem.classList.add("showfilebox");
                const leftElem = document.createElement("div");
                leftElem.classList.add("left");
                const fileTypeElem = document.createElement("span");
                fileTypeElem.classList.add("filetype");
                fileTypeElem.innerHTML = fileType;

                const fileLinkElem = document.createElement("a");
                fileLinkElem.href = fileURL;
                fileLinkElem.target = "_blank";  // Otwiera link w nowym oknie/karcie                
                fileLinkElem.innerHTML = fileName;
                fileLinkElem.classList.add("upload-link");

                leftElem.append(fileTypeElem);
                leftElem.append(fileLinkElem);                
                showfileboxElem.append(leftElem);

                const rightElem = document.createElement("div");
                rightElem.classList.add("right");
                showfileboxElem.append(rightElem);
                const trashcanElem = document.createElement("span");
                trashcanElem.innerHTML = '<i class="link fa-solid fa-trash" title="Usuń"></i>';
                rightElem.append(trashcanElem);

                filewrapper.append(showfileboxElem);

                trashcanElem.addEventListener("click", () => {
                    filewrapper.removeChild(showfileboxElem);
                    selectedFiles = selectedFiles.filter(f => f !== file);
                })

                 selectedFiles.push(file);
            };

            submitButton.addEventListener("click", () => {
                const formData = new FormData();
                selectedFiles.forEach(file => {
                    formData.append("files", file);
                });

                fetch("/add-equipment/upload-files", {
                    method: "POST",
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {                        
                        console.log(data);
                    })
                    .catch(error => {                        
                        console.error("Błąd:", error);
                    });
            });
        });    

    </script>
}